version: 1

deploy:
  steps:
    setupVariables:
      after:
        - pip3 install checkov==2.0.48
    terraformPlan:
      after:
        - terraform show -json .tf-plan | jq '.' > plan.json
        #- checkov -f plan.json --quiet --skip-check CKV_AWS_79
        - checkov -f plan.json --quiet --skip-check CKV_AWS_2,CKV_AWS_135,CKV_AWS_8,CKV_AWS_126,CKV_AWS_79 || (echo 'Checkov security checks failed - ' $(checkov -f plan.json --quiet --skip-check CKV_AWS_2,CKV_AWS_135,CKV_AWS_8,CKV_AWS_126,CKV_AWS_79 | grep 'Passed checks:') 1>&2 && exit 1)
